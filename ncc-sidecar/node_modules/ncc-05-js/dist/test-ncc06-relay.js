import { NCC05Publisher, NCC05Resolver } from './index.js';
import { generateSecretKey, getPublicKey, nip19 } from 'nostr-tools';
async function testNCC06Relay() {
    console.log('Testing NCC-06 (identity-bound) relay string handling...');
    const sk = generateSecretKey();
    const pk = getPublicKey(sk);
    const npub = nip19.npubEncode(pk);
    // Simulate an NCC-06 relay URL
    const ncc06Relay = `wss://${npub}`;
    const relays = [ncc06Relay];
    const publisher = new NCC05Publisher();
    const resolver = new NCC05Resolver({ bootstrapRelays: relays });
    console.log('Testing if publisher accepts NCC-06 relay URL...');
    const payload = {
        v: 1,
        ttl: 60,
        updated_at: Math.floor(Date.now() / 1000),
        endpoints: [
            { type: 'tcp', uri: '127.0.0.1:9000', priority: 1, family: 'ipv4' }
        ]
    };
    try {
        // We don't expect it to succeed in connecting since it's a fake URL, 
        // but we want to see if it tries or if it throws a validation error early.
        // In a real scenario, this would test the library's ability to pass the string to SimplePool.
        await publisher.publish(relays, sk, payload);
    }
    catch (e) {
        // If it failed due to connection error, that's fine for this test 
        // (as long as it didn't fail due to "Invalid relay URL" or similar argument error)
        console.log(`Publisher attempted to use ${ncc06Relay}. Result: ${e.message}`);
        if (e.message.includes('Invalid URL') || e.message.includes('Invalid hex key')) {
            console.error('FAILED: NCC-06 relay URL rejected as invalid.');
            process.exit(1);
        }
    }
    console.log('Testing if resolver accepts NCC-06 bootstrap relay...');
    try {
        // We set timeout low so we don't wait forever
        const quickResolver = new NCC05Resolver({ bootstrapRelays: relays, timeout: 500 });
        await quickResolver.resolve(pk, sk);
    }
    catch (e) {
        console.log(`Resolver attempted to use ${ncc06Relay}. Result: ${e.message}`);
        if (e.message.includes('Invalid URL')) {
            console.error('FAILED: NCC-06 relay URL rejected as invalid.');
            process.exit(1);
        }
    }
    console.log('NCC-06 relay string handling test passed (it at least accepts the format).');
    publisher.close(relays);
    resolver.close();
}
testNCC06Relay().catch(e => {
    console.error(e);
    process.exit(1);
});
